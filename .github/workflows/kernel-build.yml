name: Build Haswell Speed Kernel
on:
  workflow_dispatch:
    inputs:
      opt_level:
        description: 'Optimization Level'
        default: 'O3'

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install Dependencies
        run: pacman -Syu --noconfirm base-devel git bc pahole cpio perl tar xz xmlto kmod inetutils

      - name: Checkout CachyOS Source
        run: |
          # Cloning CachyOS because it defaults to the BORE scheduler (Great for dual-core responsiveness)
          git clone --depth 1 https://github.com/CachyOS/linux-cachyos.git linux
          cd linux

      - name: Configure for Haswell Speed
        working-directory: linux
        run: |
          make defconfig

          # --- 1. CPU ARCHITECTURE (The Speed) ---
          # Force Haswell AVX2 instructions. Generic kernels don't use these.
          echo "KCFLAGS += -march=haswell -mtune=haswell -O3 -pipe" >> Makefile
          scripts/config --enable MNATIVE_INTEL
          scripts/config --disable GENERIC_CPU

          # --- 2. SCHEDULER & LATENCY (The Snap) ---
          # 1000Hz tick rate is mandatory for smoothness on older CPUs
          scripts/config --enable HZ_1000
          scripts/config --disable HZ_300
          scripts/config --enable SCHED_BORE
          scripts/config --enable PREEMPT

          # --- 3. STRIP MITIGATIONS (The Unshackling) ---
          # Remove the Intel security patches that slow down Haswell by ~20%
          scripts/config --disable PAGE_TABLE_ISOLATION
          scripts/config --disable RETPOLINE
          scripts/config --disable MITIGATION_SPECTRE_V2
          scripts/config --disable MITIGATION_SPECTRE_V1
          scripts/config --disable MITIGATION_SSB
          scripts/config --disable MITIGATION_L1TF
          scripts/config --disable MITIGATION_MDS

          # --- 4. DRIVER SAFETY (The Future Proofing) ---
          # Explicitly enable drivers for devices you might plug in later
          scripts/config --enable NTFS3_FS
          scripts/config --enable EXFAT_FS
          scripts/config --enable USB_UAS
          scripts/config --enable KVM_INTEL
          scripts/config --enable OVERLAY_FS

          make olddefconfig

      - name: Build Kernel
        working-directory: linux
        run: make -j$(nproc) bzImage modules

      - name: Package Artifacts
        working-directory: linux
        run: |
          mkdir -p ../artifact/boot
          cp arch/x86/boot/bzImage ../artifact/boot/vmlinuz-linux-haswell
          make INSTALL_MOD_PATH=../artifact modules_install
          # Strip huge debug symbols to keep download small
          find ../artifact/lib/modules -name "*.ko" -exec strip --strip-debug {} +

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: haswell-speed-kernel
          path: artifact/
