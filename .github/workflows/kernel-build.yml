name: Build CachyOS Haswell Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
      - name: Install Base Tools
        run: |
          # Initialize pacman keys
          pacman-key --init
          pacman-key --populate archlinux
          # Install dependencies for Kernel + Rust + BPF
          pacman -Syu --noconfirm --needed base-devel git llvm clang lld wget bc cpio pahole python rust rust-bindgen rust-src

      - name: Clone CachyOS PKGBUILD Repo
        run: |
          git clone https://github.com/CachyOS/linux-cachyos.git workdir
      
      - name: Configure for Ultimate Performance
        working-directory: ./workdir/linux-cachyos
        run: |
          # 1. Set Architecture to Haswell (v3)
          sed -i 's/_march="x86-64-v3"/_march="x86-64-v3"/g' PKGBUILD
          
          # 2. Download Source
          useradd builduser -m
          chown -R builduser:builduser .
          su builduser -c "makepkg --nobuild --skipinteg"
          
          # Go into the source directory (Robust Find)
          cd $(find src -maxdepth 1 -type d -name "linux-*" | head -n 1)
          
          # --- MITIGATIONS (DISABLE ALL) ---
          scripts/config --disable CONFIG_PAGE_TABLE_ISOLATION
          scripts/config --disable CONFIG_RETPOLINE
          scripts/config --disable CONFIG_CPU_IBPB_ENTRY
          scripts/config --disable CONFIG_CPU_IBRS_ENTRY
          scripts/config --disable CONFIG_SLS
          scripts/config --set-str CONFIG_CMDLINE "mitigations=off"
          scripts/config --enable CONFIG_CMDLINE_BOOL
          
          # --- PERFORMANCE & GOVERNOR ---
          scripts/config --enable CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --disable CONFIG_CC_OPTIMIZE_FOR_SIZE
          scripts/config --disable CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL
          scripts/config --disable CONFIG_CPU_FREQ_DEFAULT_GOV_POWERSAVE
          scripts/config --enable CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE
          scripts/config --enable CONFIG_X86_INTEL_PSTATE
          
          # --- LTO (DISABLE FOR BUILD SPEED) ---
          # Enabling this doubles build time. Disabled for sanity.
          scripts/config --enable CONFIG_LTO_CLANG
          scripts/config --enable CONFIG_LTO_CLANG_THIN
          scripts/config --disable CONFIG_LTO_CLANG_FULL
          
          # --- DEBUG INFO (REQUIRED FOR BPF TOOLS) ---
          # We must keep BTF enabled or the build crashes.
          scripts/config --enable CONFIG_DEBUG_INFO
          scripts/config --enable CONFIG_DEBUG_INFO_BTF
          scripts/config --enable CONFIG_DEBUG_INFO_DWARF5
          scripts/config --disable CONFIG_DEBUG_INFO_DWARF4
          # Disable heavy runtime debugging
          scripts/config --disable CONFIG_DEBUG_KERNEL
          scripts/config --disable CONFIG_DEBUG_MISC
          scripts/config --disable CONFIG_FTRACE
          scripts/config --disable CONFIG_KALLSYMS
          scripts/config --disable CONFIG_SECURITY_DMESG_RESTRICT
          
          # --- GPU STRIPPING (Intel Only) ---
          scripts/config --disable CONFIG_DRM_AMDGPU
          scripts/config --disable CONFIG_DRM_NOUVEAU
          
          # --- TAILORED DRIVER STRIPPING (ATHEROS AR9565 + REALTEK) ---
          # WIFI: Keep Atheros, Kill Broadcom/Intel/Others
          scripts/config --disable CONFIG_WLAN_VENDOR_ADMTEK
          # scripts/config --disable CONFIG_WLAN_VENDOR_ATH  <-- KEPT!
          scripts/config --disable CONFIG_WLAN_VENDOR_ATMEL
          scripts/config --disable CONFIG_WLAN_VENDOR_BROADCOM
          scripts/config --disable CONFIG_WLAN_VENDOR_CISCO
          scripts/config --disable CONFIG_WLAN_VENDOR_INTERSIL
          scripts/config --disable CONFIG_WLAN_VENDOR_MARVELL
          scripts/config --disable CONFIG_WLAN_VENDOR_MEDIATEK
          scripts/config --disable CONFIG_WLAN_VENDOR_RALINK
          scripts/config --disable CONFIG_WLAN_VENDOR_REALTEK
          scripts/config --disable CONFIG_WLAN_VENDOR_RSI
          scripts/config --disable CONFIG_WLAN_VENDOR_ST
          scripts/config --disable CONFIG_WLAN_VENDOR_TI
          scripts/config --disable CONFIG_WLAN_VENDOR_ZYDAS
          scripts/config --disable CONFIG_WLAN_VENDOR_QUANTENNA
          
          # Ensure Atheros modules are on
          scripts/config --enable CONFIG_ATH9K
          scripts/config --enable CONFIG_ATH9K_PCI
          scripts/config --enable CONFIG_ATH9K_COMMON
          
          # ETHERNET: Keep Realtek, Kill Others
          scripts/config --disable CONFIG_NET_VENDOR_3COM
          scripts/config --disable CONFIG_NET_VENDOR_ADAPTEC
          scripts/config --disable CONFIG_NET_VENDOR_AMAZON
          scripts/config --disable CONFIG_NET_VENDOR_AMD
          scripts/config --disable CONFIG_NET_VENDOR_AQUANTIA
          scripts/config --disable CONFIG_NET_VENDOR_ARC
          scripts/config --disable CONFIG_NET_VENDOR_ATHEROS
          scripts/config --disable CONFIG_NET_VENDOR_BROADCOM
          scripts/config --disable CONFIG_NET_VENDOR_CADENCE
          scripts/config --disable CONFIG_NET_VENDOR_CAVIUM
          scripts/config --disable CONFIG_NET_VENDOR_CHELSIO
          scripts/config --disable CONFIG_NET_VENDOR_CISCO
          scripts/config --disable CONFIG_NET_VENDOR_DEC
          scripts/config --disable CONFIG_NET_VENDOR_DLINK
          scripts/config --disable CONFIG_NET_VENDOR_EMULEX
          scripts/config --disable CONFIG_NET_VENDOR_GOOGLE
          scripts/config --disable CONFIG_NET_VENDOR_HUAWEI
          scripts/config --disable CONFIG_NET_VENDOR_MARVELL
          scripts/config --disable CONFIG_NET_VENDOR_MELLANOX
          scripts/config --disable CONFIG_NET_VENDOR_MICREL
          scripts/config --disable CONFIG_NET_VENDOR_MICROCHIP
          scripts/config --disable CONFIG_NET_VENDOR_MICROSEMI
          scripts/config --disable CONFIG_NET_VENDOR_MYRI
          scripts/config --disable CONFIG_NET_VENDOR_NATSEMI
          scripts/config --disable CONFIG_NET_VENDOR_NETERION
          scripts/config --disable CONFIG_NET_VENDOR_NI
          scripts/config --disable CONFIG_NET_VENDOR_NVIDIA
          scripts/config --disable CONFIG_NET_VENDOR_OKI
          scripts/config --disable CONFIG_NET_VENDOR_PACKET_ENGINES
          scripts/config --disable CONFIG_NET_VENDOR_QLOGIC
          scripts/config --disable CONFIG_NET_VENDOR_QUALCOMM
          scripts/config --disable CONFIG_NET_VENDOR_RDC
          scripts/config --disable CONFIG_NET_VENDOR_RENESAS
          scripts/config --disable CONFIG_NET_VENDOR_ROCKER
          scripts/config --disable CONFIG_NET_VENDOR_SAMSUNG
          scripts/config --disable CONFIG_NET_VENDOR_SEEQ
          scripts/config --disable CONFIG_NET_VENDOR_SOLARFLARE
          scripts/config --disable CONFIG_NET_VENDOR_SILAN
          scripts/config --disable CONFIG_NET_VENDOR_SIS
          scripts/config --disable CONFIG_NET_VENDOR_SMSC
          scripts/config --disable CONFIG_NET_VENDOR_SOCIONEXT
          scripts/config --disable CONFIG_NET_VENDOR_STMICRO
          scripts/config --disable CONFIG_NET_VENDOR_SUN
          scripts/config --disable CONFIG_NET_VENDOR_SYNOPSYS
          scripts/config --disable CONFIG_NET_VENDOR_TEHUTI
          scripts/config --disable CONFIG_NET_VENDOR_TI
          scripts/config --disable CONFIG_NET_VENDOR_VIA
          scripts/config --disable CONFIG_NET_VENDOR_WIZNET
          scripts/config --disable CONFIG_NET_VENDOR_XILINX
          # scripts/config --disable CONFIG_NET_VENDOR_REALTEK <-- KEPT!
          
          # SOUND (Keep Intel HDA)
          scripts/config --disable CONFIG_SND_SOC
          scripts/config --disable CONFIG_SND_PCI
          scripts/config --enable CONFIG_SND_HDA_INTEL
          
          # --- DOCKER SUPPORT ---
          scripts/config --enable CONFIG_NAMESPACES
          scripts/config --enable CONFIG_NET_NS
          scripts/config --enable CONFIG_PID_NS
          scripts/config --enable CONFIG_IPC_NS
          scripts/config --enable CONFIG_UTS_NS
          scripts/config --enable CONFIG_CGROUPS
          scripts/config --enable CONFIG_CGROUP_CPUACCT
          scripts/config --enable CONFIG_CGROUP_DEVICE
          scripts/config --enable CONFIG_CGROUP_FREEZER
          scripts/config --enable CONFIG_CGROUP_SCHED
          scripts/config --enable CONFIG_CPUSETS
          scripts/config --enable CONFIG_MEMCG
          scripts/config --enable CONFIG_KEYS
          scripts/config --enable CONFIG_VETH
          scripts/config --enable CONFIG_BRIDGE
          scripts/config --enable CONFIG_BRIDGE_NETFILTER
          scripts/config --enable CONFIG_NF_NAT_IPV4
          scripts/config --enable CONFIG_IP_NF_FILTER
          scripts/config --enable CONFIG_IP_NF_TARGET_MASQUERADE
          scripts/config --enable CONFIG_NETFILTER_XT_MATCH_ADDRTYPE
          scripts/config --enable CONFIG_NETFILTER_XT_MATCH_CONNTRACK
          scripts/config --enable CONFIG_NETFILTER_XT_MATCH_IPVS
          scripts/config --enable CONFIG_IP_NF_NAT
          scripts/config --enable CONFIG_NF_NAT
          scripts/config --enable CONFIG_NF_NAT_NEEDED
          scripts/config --enable CONFIG_POSIX_MQUEUE
          
          # --- TETHERING ---
          scripts/config --enable CONFIG_USB_NET_RNDIS_HOST
          scripts/config --enable CONFIG_USB_NET_CDCETHER
          
          # Validate config
          make olddefconfig

      - name: Compile Kernel
        working-directory: ./workdir/linux-cachyos
        run: |
          chown -R builduser:builduser .
          # -s installs dependencies (bc, cpio, etc if missing but we installed them)
          su builduser -c "makepkg --noextract --noprepare --skipinteg -s --noconfirm"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cachyos-haswell-kernel
          path: |
            workdir/linux-cachyos/*.pkg.tar.zst
