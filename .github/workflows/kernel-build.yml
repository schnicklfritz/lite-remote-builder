name: Build Haswell Speed Kernel (Pacman Ready)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install Build Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git bc xmlto kmod inetutils libelf cpio perl tar xz python pahole wget
          # Create build user because makepkg cannot run as root
          useradd builduser -m
          passwd -d builduser
          printf 'builduser ALL=(ALL) ALL\n' | tee -a /etc/sudoers
          chown -R builduser:builduser .

      - name: Checkout & Configure
        shell: bash
        run: |
          # Clone CachyOS PKGBUILD source
          su builduser -c "git clone https://github.com/CachyOS/linux-cachyos.git workdir"

      - name: Apply Haswell Speed Patches
        working-directory: workdir
        shell: bash
        run: |
          # We inject your aggressive config adjustments into the PKGBUILD's prepare() phase logic
          # or simply create a config fragment.
          
          # 1. Get the base config
          wget https://raw.githubusercontent.com/CachyOS/linux-cachyos/master/config -O .config
          
          # 2. Apply your HASWELL & SPEED modifications
          scripts/config --file .config --enable MNATIVE_INTEL
          scripts/config --file .config --disable GENERIC_CPU
          scripts/config --file .config --enable HZ_1000
          scripts/config --file .config --disable HZ_300
          scripts/config --file .config --enable SCHED_BORE
          scripts/config --file .config --enable PREEMPT
          
          # 3. STRIP MITIGATIONS (The Unshackling)
          scripts/config --file .config --disable PAGE_TABLE_ISOLATION
          scripts/config --file .config --disable RETPOLINE
          scripts/config --file .config --disable MITIGATION_SPECTRE_V2
          scripts/config --file .config --disable MITIGATION_SPECTRE_V1
          
          # 4. Save this modified config to replace the one in the git repo
          mv .config config

      - name: Compile (Makepkg)
        working-directory: workdir
        shell: bash
        run: |
          # Allow parallelism
          export MAKEFLAGS="-j$(nproc)"
          # Build the package (This generates the .pkg.tar.zst)
          su builduser -c "makepkg -s --noconfirm --skippgpcheck"

      - name: Upload Pacman Package
        uses: actions/upload-artifact@v4
        with:
          name: cachyos-haswell-optimized
          path: workdir/*.pkg.tar.zst
