name: Build Custom Arch Kernel
on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or Tag to build'
        default: 'main'
      opt_level:
        description: 'Optimization Level'
        default: 'O3'

jobs:
  build:
    runs-on: ubuntu-latest
    container: 
      image: archlinux:base-devel # Contains gcc, make, sudo, etc.
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # Update mirrors and install missing tools
          pacman -Syu --noconfirm
          pacman -S --noconfirm git bc pahole cpio perl tar xz kmod xmlto docbook-xsl inetutils

      - name: Prepare Builder User
        run: |
          # Makepkg cannot run as root. We create 'builder'.
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # FIX: Ensure builder owns the workspace so it can write files
          chown -R builder:builder .

      - name: Configure & Build
        shell: bash
        run: |
          # Switch to builder user for everything
          su builder -c "bash -c '
            # 1. Clone CachyOS Kernel Source (Deep Clone for versioning)
            git clone --depth 1 https://github.com/CachyOS/linux-cachyos.git linux
            cd linux

            # 2. Start with Default Config
            make defconfig

            # 3. APPLY HASWELL OPTIMIZATIONS (The Speed)
            echo \"KCFLAGS += -march=haswell -mtune=haswell -O3 -pipe\" >> Makefile
            scripts/config --enable MNATIVE_INTEL
            scripts/config --disable GENERIC_CPU
            
            # 4. APPLY LOCALMODCONFIG (The Danger Step - Handle with Care)
            if [ -f \"../../hardware_base.txt\" ]; then
               echo \"⚠️ Applying hardware strip from hardware_base.txt...\"
               # We point LSMOD to the absolute path of your uploaded text file
               export LSMOD=$(readlink -f ../../hardware_base.txt)
               make localmodconfig
            else
               echo \"ℹ️ No hardware profile found. Building generic (Safe Mode).\"
            fi

            # 5. RE-ENABLE CRITICAL MODULES (Safety Net)
            # localmodconfig might kill these if not in your text file. We force them back.
            scripts/config --enable NTFS3_FS
            scripts/config --enable EXFAT_FS
            scripts/config --enable USB_STORAGE
            scripts/config --enable USB_UAS
            scripts/config --enable KVM_INTEL

            # 6. STRIP MITIGATIONS
            scripts/config --disable PAGE_TABLE_ISOLATION
            scripts/config --disable RETPOLINE
            scripts/config --disable MITIGATION_SPECTRE_V2

            # 7. BUILD
            # Update config and build
            make olddefconfig
            make -j\$(nproc) bzImage modules
            
            # 8. PACKAGE
            mkdir -p ../artifact/boot
            cp arch/x86/boot/bzImage ../artifact/boot/vmlinuz-linux-haswell
            make INSTALL_MOD_PATH=../artifact modules_install
            # Strip debug symbols to save 500MB+
            find ../artifact/lib/modules -name \"*.ko\" -exec strip --strip-debug {} +
          '"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: custom-kernel-haswell
          path: artifact/
